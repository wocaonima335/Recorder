# éŸ³é¢‘å¯è§†åŒ–ç³»ç»Ÿè®¾è®¡æ–‡æ¡£

## ğŸ“ ç³»ç»Ÿæ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    å½•åˆ¶åº”ç”¨ (Bandicam)                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  FFmpegéŸ³é¢‘å¤„ç†å±‚                                       â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚   â”‚
â”‚  â”‚  â”‚ Demuxer     â”‚â†’ â”‚ Decoder      â”‚â†’ â”‚ AudioFrame   â”‚   â”‚   â”‚
â”‚  â”‚  â”‚ (éŸ³é¢‘æµ)    â”‚  â”‚ (è§£ç PCM)    â”‚  â”‚ (PCMæ•°æ®)    â”‚   â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚   â”‚
â”‚  â”‚                                            â†“            â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                   â†“             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  FFAudioSampler (C++çº¿ç¨‹å®‰å…¨é‡‡æ ·å™¨)                      â”‚   â”‚
â”‚  â”‚                                                          â”‚   â”‚
â”‚  â”‚  ğŸ“¥ è¾“å…¥: PCMæ ·æœ¬ (floatæˆ–int16)                        â”‚   â”‚
â”‚  â”‚     collectSamples(const float*, int)                  â”‚   â”‚
â”‚  â”‚     collectSamples(const int16_t*, int)                â”‚   â”‚
â”‚  â”‚                                                          â”‚   â”‚
â”‚  â”‚  ğŸ”„ æ ¸å¿ƒå¤„ç†:                                           â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                      â”‚   â”‚
â”‚  â”‚  â”‚ ç¯å½¢ç¼“å†²åŒº                   â”‚                      â”‚   â”‚
â”‚  â”‚  â”‚ m_sampleBuffer[96000]        â”‚ â† PCMæµå…¥            â”‚   â”‚
â”‚  â”‚  â”‚ â†‘ å¾ªç¯è¦†ç›–, å›ºå®šå†…å­˜         â”‚                      â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                      â”‚   â”‚
â”‚  â”‚              â†“ (å®šæœŸæ›´æ–°)                              â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚   â”‚
â”‚  â”‚  â”‚ updateVolumeLevel()     â”‚ updateWaveformData()   â”‚ â”‚   â”‚
â”‚  â”‚  â”‚ RMSè®¡ç®— â†’ dBè½¬æ¢ â†’ 0-100â”‚ é‡‡æ ·256ç‚¹ â†’ -100~+100  â”‚ â”‚   â”‚
â”‚  â”‚  â”‚ å¹³æ»‘å¤„ç† (0.7ç³»æ•°)      â”‚ ç”¨äºæ³¢å½¢ç»˜åˆ¶          â”‚ â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚   â”‚
â”‚  â”‚              â†“ (å¯é€‰)                                â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                        â”‚   â”‚
â”‚  â”‚  â”‚ computeSpectrum()        â”‚                        â”‚   â”‚
â”‚  â”‚  â”‚ FFTé¢‘ç‡åˆ†æ â†’ 64é¢‘æ®µ     â”‚                        â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                        â”‚   â”‚
â”‚  â”‚                                                          â”‚   â”‚
â”‚  â”‚  ğŸ“¤ è¾“å‡º: Qtä¿¡å·                                       â”‚   â”‚
â”‚  â”‚  - volumeLevelChanged(int)          â†’ éŸ³é‡0-100        â”‚   â”‚
â”‚  â”‚  - waveformDataChanged()            â†’ æ³¢å½¢256ç‚¹        â”‚   â”‚
â”‚  â”‚  - spectrumDataChanged()            â†’ é¢‘è°±64æ®µ         â”‚   â”‚
â”‚  â”‚                                                          â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                          â†“ (ä¿¡å·ä¼ é€’)                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  QMLè§†å›¾å±‚                                               â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚   â”‚
â”‚  â”‚  â”‚ AudioVisualizer (QMLç»„ä»¶)                        â”‚   â”‚   â”‚
â”‚  â”‚  â”‚                                                   â”‚   â”‚   â”‚
â”‚  â”‚  â”‚ å±æ€§ç»‘å®š:                                        â”‚   â”‚   â”‚
â”‚  â”‚  â”‚ - audioSampler: FFAudioSampler                  â”‚   â”‚   â”‚
â”‚  â”‚  â”‚ - mode: "volume" | "wave" | "spectrum"         â”‚   â”‚   â”‚
â”‚  â”‚  â”‚ - é¢œè‰²é…ç½®: volumeBarColor, waveformColorç­‰    â”‚   â”‚   â”‚
â”‚  â”‚  â”‚                                                   â”‚   â”‚   â”‚
â”‚  â”‚  â”‚ Canvasç»˜åˆ¶:                                      â”‚   â”‚   â”‚
â”‚  â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚   â”‚   â”‚
â”‚  â”‚  â”‚ â”‚ drawVolumeIndicator()  - æŸ±çŠ¶å›¾        â”‚   â”‚   â”‚   â”‚
â”‚  â”‚  â”‚ â”‚ drawWaveform()         - æ³¢å½¢æ›²çº¿      â”‚   â”‚   â”‚   â”‚
â”‚  â”‚  â”‚ â”‚ drawSpectrum()         - é¢‘è°±åˆ†å¸ƒ      â”‚   â”‚   â”‚   â”‚
â”‚  â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚   â”‚   â”‚
â”‚  â”‚  â”‚                                                   â”‚   â”‚   â”‚
â”‚  â”‚  â”‚ å®æ—¶æ›´æ–°: 60fps Canvasåˆ·æ–°                        â”‚   â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚   â”‚
â”‚  â”‚                          â†“                              â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚   â”‚
â”‚  â”‚  â”‚ Main.qml (åº”ç”¨ä¸»ç•Œé¢)                           â”‚   â”‚   â”‚
â”‚  â”‚  â”‚                                                   â”‚   â”‚   â”‚
â”‚  â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚   â”‚   â”‚
â”‚  â”‚  â”‚ â”‚ audioArea (é€‰é¡¹æ )                  â”‚         â”‚   â”‚   â”‚
â”‚  â”‚  â”‚ â”‚                                     â”‚         â”‚   â”‚   â”‚
â”‚  â”‚  â”‚ â”‚ [å½•åˆ¶ä¸­]                            â”‚         â”‚   â”‚   â”‚
â”‚  â”‚  â”‚ â”‚  â–ˆ                                  â”‚         â”‚   â”‚   â”‚
â”‚  â”‚  â”‚ â”‚  â–ˆ â–ˆ â–ˆ                              â”‚         â”‚   â”‚   â”‚
â”‚  â”‚  â”‚ â”‚  â–ˆ â–ˆ â–ˆ 50%                          â”‚         â”‚   â”‚   â”‚
â”‚  â”‚  â”‚ â”‚                                     â”‚         â”‚   â”‚   â”‚
â”‚  â”‚  â”‚ â”‚ [éå½•åˆ¶]                            â”‚         â”‚   â”‚   â”‚
â”‚  â”‚  â”‚ â”‚  ğŸ”Š Audio                          â”‚         â”‚   â”‚   â”‚
â”‚  â”‚  â”‚ â”‚  (é™æ€æ˜¾ç¤º)                         â”‚         â”‚   â”‚   â”‚
â”‚  â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚   â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚   â”‚
â”‚  â”‚                                                          â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”„ æ•°æ®æµè¯¦è§£

### 1ï¸âƒ£ é‡‡æ ·é˜¶æ®µ

```
FFmpegè§£ç å™¨è¾“å‡ºAVFrame (48kHz, 2ch, float)
    â†“
FFAudioDecoder::processFrame()
    â†“
recorder->audioSampler()->collectSamples(samples, 1024)
    â†“
[çº¿ç¨‹å®‰å…¨] std::lock_guard<std::mutex> lock(m_dataMutex);
    â†“
å°†1024ä¸ªfloatæ ·æœ¬å†™å…¥ç¯å½¢ç¼“å†²åŒº
m_sampleBuffer[m_bufferIndex++] = sample;  // m_bufferIndexå¾ªç¯
    â†“
ç¼“å†²åŒºçŠ¶æ€: [......å·²ç”¨......|......å¾…ç”¨......]
                  â†‘                 â†‘
          è¯»å–æŒ‡é’ˆ(updateæ—¶)    å†™å…¥æŒ‡é’ˆ(å¾ªç¯å¢é•¿)
```

### 2ï¸âƒ£ å¤„ç†é˜¶æ®µ (å®šæœŸè§¦å‘)

```
collectSamples()è°ƒç”¨æ¯3æ¬¡å:

updateVolumeLevel():
    â”œâ”€ å–æœ€å1ç§’(48000ä¸ªæ ·æœ¬)
    â”œâ”€ è®¡ç®—RMS = sqrt(Î£sÂ²/N)
    â”œâ”€ è½¬dB = 20*logâ‚â‚€(RMS)
    â”œâ”€ å¹³æ»‘: newLevel = old*0.7 + calc*0.3
    â””â”€ emit volumeLevelChanged()

updateWaveformData():
    â”œâ”€ ä»ç¼“å†²åŒºé‡‡256ä¸ªç­‰è·ç‚¹
    â”œâ”€ æ¯ç‚¹è½¬ä¸º-100~+100èŒƒå›´
    â””â”€ emit waveformDataChanged()

computeSpectrum() [å¯é€‰]:
    â”œâ”€ åˆ†ç¼“å†²åŒºä¸º64ä¸ªé¢‘ç‡æ®µ
    â”œâ”€ è®¡ç®—æ¯æ®µèƒ½é‡
    â”œâ”€ è½¬dB + 0-1å½’ä¸€åŒ–
    â””â”€ emit spectrumDataChanged()
```

### 3ï¸âƒ£ æ¸²æŸ“é˜¶æ®µ

```
AudioVisualizer.qml æ”¶åˆ°ä¿¡å·:

onVolumeLevelChanged(newLevel):
    â”œâ”€ currentVolume = newLevel
    â””â”€ canvas.requestPaint()

onWaveformDataChanged():
    â”œâ”€ waveformData = audioSampler.waveformData
    â””â”€ canvas.requestPaint()

Canvas.onPaint():
    â”œâ”€ æ ¹æ®modeé€‰æ‹©ç»˜åˆ¶å‡½æ•°
    â”œâ”€ drawVolumeIndicator(ctx)  æˆ–
    â”œâ”€ drawWaveform(ctx)  æˆ–
    â””â”€ drawSpectrum(ctx)

æœ€ç»ˆæ˜¾ç¤º: ä¸»çº¿ç¨‹60fpsæ›´æ–°UI
```

---

## ğŸ§  æ ¸å¿ƒç®—æ³•è¯¦è§£

### éŸ³é‡è®¡ç®— (RMS â†’ dB â†’ ç™¾åˆ†æ¯”)

```
æ­¥éª¤1: é‡‡æ ·çª—å£ = 1ç§’ (48000ä¸ªfloatæ ·æœ¬)

æ­¥éª¤2: è®¡ç®—å‡æ–¹å€¼
    E[XÂ²] = (1/N) Ã— Î£(x[n]Â²)

    ç¤ºä¾‹: 4ä¸ªæ ·æœ¬ [0.1, -0.2, 0.15, -0.05]
    E[XÂ²] = (0.01 + 0.04 + 0.0225 + 0.0025) / 4 = 0.01375

æ­¥éª¤3: å¼€æ–¹å¾—RMS
    RMS = âˆšE[XÂ²] = âˆš0.01375 â‰ˆ 0.1173

æ­¥éª¤4: è½¬æ¢ä¸ºåˆ†è´
    dB = 20 Ã— logâ‚â‚€(RMS)
    dB = 20 Ã— logâ‚â‚€(0.1173) â‰ˆ -18.61 dB

    çº¦æŸ: [-40, 0] dB (äººç±»å¬è§‰èŒƒå›´)

æ­¥éª¤5: å½’ä¸€åŒ–åˆ°ç™¾åˆ†æ¯”
    ç™¾åˆ†æ¯” = (dB + 40) / 40 Ã— 100
    ç™¾åˆ†æ¯” = (-18.61 + 40) / 40 Ã— 100 â‰ˆ 53.5%

æ­¥éª¤6: åº”ç”¨å¹³æ»‘å› å­
    final = old Ã— 0.7 + new Ã— 0.3

    å¥½å¤„: é¿å…æŠ–åŠ¨, æå‡è§†è§‰ç¨³å®šæ€§
```

### æ³¢å½¢æå– (é‡‡æ · 256 ç‚¹)

```
ç¼“å†²åŒº: 96000ä¸ªæ ·æœ¬, å·²å†™å…¥48000ä¸ª

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ [å·²å†™] Â·Â·Â·Â·Â·Â·Â·Â·Â· | [æœªå†™] Â·Â·Â·Â·Â·Â·Â·Â·Â· ç¼“å†²åŒº â”‚
â”‚  â†‘               â†‘               â†‘         â”‚
â”‚  0          m_bufferIndex    96000        â”‚
â”‚             å½“å‰å†™å…¥ä½ç½®                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

æå–256ä¸ªæ˜¾ç¤ºç‚¹:
    stride = 96000 / 256 = 375 (æ ·æœ¬é—´éš”)

    point[0] = buffer[(bufferIndex - 256*375) % 96000]
    point[1] = buffer[(bufferIndex - 255*375) % 96000]
    ...
    point[255] = buffer[bufferIndex - 375]

ç»“æœ: è¿‘ä¼¼æ˜¾ç¤ºç¼“å†²åŒºæœ€åçš„æ³¢å½¢

æ—¶é—´å…³ç³»: 96000æ ·æœ¬ @ 48kHz = 2ç§’
         æ˜¾ç¤º æœ€è¿‘1.5ç§’çš„æ³¢å½¢ (ä»128ç§’å‰å¼€å§‹)
```

### é¢‘è°±è®¡ç®— (ç®€åŒ–ç‰ˆ)

```
å°†48000æ ·æœ¬åˆ†ä¸º64ä¸ªé¢‘ç‡æ®µ:

æ®µå¤§å° = 48000 / 64 â‰ˆ 750æ ·æœ¬

å¯¹æ¯ä¸ªæ®µè®¡ç®—èƒ½é‡:
    E[bin_i] = âˆš(Î£(xÂ²) / 750)  for bin_i

è½¬dB:
    dB[i] = 20 Ã— logâ‚â‚€(E[i])  , çº¦æŸ[-100, 0]

å½’ä¸€åŒ–:
    spectrum[i] = (dB[i] + 100) / 100  âˆˆ [0, 1]

é¢‘ç‡å¯¹åº”:
    bin_0  (ä½é¢‘) â† 0-748Hz
    bin_32 (ä¸­é¢‘) â† 12kHz
    bin_63 (é«˜é¢‘) â† 24-24kHz

ç»˜åˆ¶: 64ä¸ªç«–æŸ±, é«˜åº¦ âˆ spectrum[i]
```

---

## ğŸ” çº¿ç¨‹å®‰å…¨è®¾è®¡

### ç«æ€æ¡ä»¶åˆ†æ

```
çº¿ç¨‹A (FFmpegè§£ç )            çº¿ç¨‹B (QMLæ¸²æŸ“)
    â†“                              â†“
collectSamples()             getWaveformData()
    â”‚                              â”‚
    â”œâ”€ m_bufferIndex++            â”œâ”€ for(i < 256)
    â”œâ”€ m_sampleBuffer[...] = x    â”‚   waveformData[i] =
    â””â”€ emit signal()              â”‚       m_sampleBuffer[...]
                                  â””â”€ è¿”å›å‰¯æœ¬
```

### äº’æ–¥ä¿æŠ¤

```cpp
// å†™å…¥ç«¯ (é‡‡æ ·å™¨)
void collectSamples() {
    std::lock_guard<std::mutex> lock(m_dataMutex);
    // ä¸´ç•ŒåŒº: å†™å…¥ç¼“å†²åŒº, æ›´æ–°ç´¢å¼•
}

// è¯»å–ç«¯ (QML)
QVector<int> getWaveformData() const {
    std::lock_guard<std::mutex> lock(m_dataMutex);
    // ä¸´ç•ŒåŒº: è¯»å–æ•°æ®, åˆ›å»ºå‰¯æœ¬
    return QVector<int>(m_waveformData.begin(), m_waveformData.end());
}

// lock_guardçš„ä½œç”¨:
// - è¿›å…¥ä½œç”¨åŸŸæ—¶è‡ªåŠ¨ä¸Šé”
// - ç¦»å¼€ä½œç”¨åŸŸæ—¶è‡ªåŠ¨è§£é” (å³ä½¿å¼‚å¸¸ä¹Ÿèƒ½è§£é”)
// - é¿å…æ­»é”
```

### ä¼˜åŒ–: æœ€å°åŒ–ä¸´ç•ŒåŒº

```cpp
void collectSamples(const float *samples, int sampleCount) {
    // Phase 1: éä¸´ç•Œä»£ç  (æ ¼å¼æ£€æŸ¥)
    if (!m_isActive || !samples) return;

    {
        // Phase 2: ä¸´ç•ŒåŒº (æœ€å°åŒ–æ—¶é—´)
        std::lock_guard<std::mutex> lock(m_dataMutex);

        // å¿«é€Ÿå†™å…¥ç¯å½¢ç¼“å†²åŒº
        for (int i = 0; i < sampleCount; ++i) {
            m_sampleBuffer[m_bufferIndex] = samples[i];
            m_bufferIndex = (m_bufferIndex + 1) % m_sampleBuffer.size();
        }

        m_updateCounter++;
        if (m_updateCounter >= SIGNAL_UPDATE_INTERVAL) {
            m_updateCounter = 0;
            // è®¡ç®—ä½†ä¸å‘ä¿¡å· (åœ¨é”å†…å®Œæˆ)
            updateVolumeLevel();
            updateWaveformData();
        }
    } // lock_guardé‡Šæ”¾

    // Phase 3: å‘ä¿¡å· (é”å¤–)
    emit volumeLevelChanged(m_volumeLevel);  // å·²å®‰å…¨
}
```

---

## ğŸ“¦ å†…å­˜ç®¡ç†

### å›ºå®šå†…å­˜å¸ƒå±€

```
FFAudioSampler å¯¹è±¡å†…å­˜åˆ†é… (ä»…ä¸€æ¬¡):

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ FFAudioSamplerå®ä¾‹                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ m_sampleBuffer          96000 floats    â”‚ 384 KB
â”‚ m_waveformData          256 ints        â”‚ 1 KB
â”‚ m_spectrumData          64 floats       â”‚ 256 B
â”‚ m_volumeLevel           1 int           â”‚ 4 B
â”‚ å…¶ä»–æˆå‘˜ (æŒ‡é’ˆç­‰)       ~200 B          â”‚ 200 B
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ æ€»è®¡                                     â”‚ ~385 KB
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

é‡è¦: ç¼“å†²åŒºå¤§å°å›ºå®š, ä¸ä¼šè†¨èƒ€æˆ–æ³„æ¼

é‡‡ç”¨æ–¹æ¡ˆ:
âœ“ std::vector è‡ªç®¡ç†
âœ“ std::unique_ptr è‡ªåŠ¨é‡Šæ”¾
âœ“ std::mutex åŒ…å«åœ¨å¯¹è±¡å†…
```

### ç”Ÿå‘½å‘¨æœŸ

```
FFRecorder åˆå§‹åŒ–:
    â†“
new FFAudioSampler(this)  // æ„é€ , åˆ†é…å†…å­˜
    â†“
initialize(48000, 2, ...)  // ç¼“å†²åŒºè°ƒæ•´
    â†“
[è¿è¡Œä¸­]
start() â†’ collectSamples() (å¾ªç¯)
stop() â†’ clear() (é‡ç½®)
    â†“
FFRecorderææ„:
    â†“
~FFAudioSampler() (unique_ptrè‡ªåŠ¨åˆ é™¤)
    â†“
æ‰€æœ‰å†…å­˜é‡Šæ”¾
```

---

## âš¡ æ€§èƒ½ç‰¹æ€§

### æ—¶é—´å¤æ‚åº¦

| æ“ä½œ                 | å¤æ‚åº¦ | æ‰§è¡Œæ—¶é—´    |
| -------------------- | ------ | ----------- |
| collectSamples(1024) | O(n)   | <1ms        |
| updateVolumeLevel()  | O(n)   | <2ms        |
| updateWaveformData() | O(n)   | <1ms        |
| computeSpectrum()    | O(n)   | <5ms        |
| getWaveformData()    | O(256) | <0.5ms      |
| Canvas ç»˜åˆ¶          | O(1)   | <5ms @60fps |

### CPU å ç”¨ä¼°ç®—

```
é‡‡æ ·ç‡: 48kHz
æ›´æ–°é—´éš”: 3æ¬¡ (16ms)
å•æ¬¡å¤„ç†: 3Ã—1024 = 3072æ ·æœ¬

å·¥ä½œé‡ = 3072 / 48000 / 0.016 â‰ˆ 4%

+é¢å¤–å¤„ç† (RMS,FFTç­‰): 1%

æ€»CPUå ç”¨: ~5% (å•æ ¸, ç›¸å¯¹äºå½•åˆ¶æœ¬èº«<1%)
```

### å†…å­˜å ç”¨

```
å›ºå®šå¼€é”€: 385 KB (ç¼“å†²åŒº)
åŠ¨æ€å¼€é”€: ~10 KB (ä¿¡å·é˜Ÿåˆ—, ä¸´æ—¶å˜é‡)

æ€»è®¡: ~400 KB (æä½)

ä¸1080pè§†é¢‘å¸§å¯¹æ¯”:
- 1920Ã—1080 RGB = 6.2 MB
- éŸ³é¢‘é‡‡æ ·å™¨ = 0.4 MB
- æ¯”ä¾‹ = 0.4 / 6.2 â‰ˆ 6% (å¯å¿½ç•¥)
```

---

## ğŸ”Œ é›†æˆæ¥å£å®šä¹‰

### C++ æ¥å£

```cpp
class FFAudioSampler : public QObject {
public:
    // åˆå§‹åŒ–
    void initialize(int sampleRate, int channels, int format);

    // é‡‡æ · (çƒ­è·¯å¾„)
    void collectSamples(const float *samples, int sampleCount);
    void collectSamples(const int16_t *samples, int sampleCount);

    // æ§åˆ¶
    void start();
    void stop();
    void clear();

    // æŸ¥è¯¢ (åªè¯»)
    int getVolumeLevel() const;
    QVector<int> getWaveformData() const;
    QVector<float> getSpectrumData() const;
    bool isActive() const;

signals:
    void volumeLevelChanged(int);
    void waveformDataChanged();
    void spectrumDataChanged();
    void activeStateChanged(bool);
};
```

### QML é›†æˆ

```qml
AudioVisualizer {
    // å¿…éœ€å±æ€§
    audioSampler: recorder.audioSampler

    // å¯é€‰å±æ€§
    mode: "volume"              // æ˜¾ç¤ºæ¨¡å¼
    volumeBarColor: "#00FF00"   // é¢œè‰²

    // åªè¯» (ä»C++è¯»)
    currentVolume: audioSampler.volumeLevel
    waveformData: audioSampler.waveformData
    spectrumData: audioSampler.spectrumData
}
```

---

## ğŸ¯ è®¾è®¡å†³ç­–è¯´æ˜

### ä¸ºä»€ä¹ˆä½¿ç”¨ç¯å½¢ç¼“å†²åŒº?

âœ“ **å›ºå®šå†…å­˜**: ä¸ä¼šå› æ—¶é—´å¢é•¿è€Œè†¨èƒ€
âœ“ **é«˜æ•ˆ**: O(1)å†™å…¥, æ— å†…å­˜é‡åˆ†é…
âœ“ **ç®€æ´**: æ— éœ€é“¾è¡¨æˆ–åŠ¨æ€è°ƒæ•´
âœ— ç¼ºç‚¹: è®¾è®¡ç•¥å¤æ‚ (ä½†å€¼å¾—)

### ä¸ºä»€ä¹ˆå¯¹æ•°åˆ»åº¦ (dB)?

âœ“ **ç¬¦åˆå¬è§‰**: äººè€³æ„ŸçŸ¥æ˜¯å¯¹æ•°çš„
âœ“ **èŒƒå›´å¹¿**: -40 åˆ° 0 dB å¯¹åº” 20000 å€èƒ½é‡å·®
âœ“ **å‚è€ƒæ ‡å‡†**: ä¸ FFplay å’ŒéŸ³é¢‘å·¥å…·ä¸€è‡´
âœ— ç¼ºç‚¹: è®¡ç®—ç•¥å¤æ‚ (ä½† cpu å¼€é”€<0.1ms)

### ä¸ºä»€ä¹ˆä¿¡å·å¼‚æ­¥?

âœ“ **ä½å»¶è¿Ÿ**: é‡‡æ ·å³æ—¶è¿›è¡Œ
âœ“ **é«˜æ•ˆ**: ä¿¡å·åœ¨é”å¤–å‘é€, é¿å…é˜»å¡
âœ“ **QML å‹å¥½**: Canvas è‡ªåŠ¨åˆ·æ–°
âœ— ç¼ºç‚¹: æ•°æ®å¯èƒ½æœ‰å°å»¶è¿Ÿ (<50ms)

### ä¸ºä»€ä¹ˆä¸‰ç§æ˜¾ç¤ºæ¨¡å¼?

âœ“ **çµæ´»**: ä¸åŒåœºæ™¯éœ€è¦
âœ“ **æ¨¡å—åŒ–**: å¯ç‹¬ç«‹å¯ç”¨/ç¦ç”¨
âœ“ **æ‰©å±•æ€§**: æ˜“æ·»åŠ æ–°æ¨¡å¼
âœ— ç¼ºç‚¹: Canvas ä»£ç ç¨å†—é•¿

---

## ğŸš€ æœªæ¥æ”¹è¿›æ–¹å‘

### Level 1: å¢å¼ºå‹æ˜¾ç¤º

```cpp
// æ·»åŠ å®æ—¶é¢‘ç‡æ˜¾ç¤º
struct FrequencyInfo {
    float centerFreq;      // ä¸­å¿ƒé¢‘ç‡
    float bandwidth;       // å¸¦å®½
    float magnitude;       // èƒ½é‡
};

// æ·»åŠ å³°å€¼æŒ‡ç¤º
class PeakHoldIndicator {
    void holdPeak(int duration);  // ms
};
```

### Level 2: é«˜çº§åˆ†æ

```cpp
// LUFS (Loudness Units Relative to Full Scale)
class LUFSMeter {
    // ITU-R BS.1770 æ ‡å‡†
    float calculateLUFS();
};

// çœŸæ­£çš„FFT (vså½“å‰ç®€åŒ–ç‰ˆ)
class RealFFTAnalyzer {
    void computeFFT(const float *input, float *output);
};
```

### Level 3: å¤šç«¯æ”¯æŒ

```cpp
// æ”¯æŒå¤šéŸ³é¢‘æµ
std::map<int, FFAudioSampler*> m_samplers;

// æ”¯æŒéŸ³é¢‘è·¯ç”±
void routeAudioToSampler(int streamId, const AVFrame *frame);
```

---

## ğŸ“š å‚è€ƒä¸è§„èŒƒ

### éŸ³é¢‘æ ‡å‡†

- ITU-R BS.1770: LUFS æµ‹é‡
- IEC 61672: é¢‘ç‡åŠ æƒ
- AES: éŸ³é¢‘å·¥ç¨‹å­¦ä¼šæ ‡å‡†

### å®ç°å‚è€ƒ

- FFmpeg libavfilter (éŸ³é¢‘å¤„ç†)
- FFplay source (å‚è€ƒå®ç°)
- Qt Canvas (ç»˜åˆ¶æ¥å£)

### æµ‹è¯•ç”¨ä¾‹

```cpp
// å•å…ƒæµ‹è¯•æ¡†æ¶ (å»ºè®®)
TEST_CASE("RMSè®¡ç®—") {
    FFAudioSampler sampler;
    sampler.initialize(48000, 2, AV_SAMPLE_FMT_FLT);

    // ç”Ÿæˆæµ‹è¯•ä¿¡å·
    float testSignal[1000] = {0.1, -0.1, ...};
    sampler.collectSamples(testSignal, 1000);

    REQUIRE(sampler.getVolumeLevel() == Approx(expected));
}
```

---

**æœ€åæ›´æ–°**: 2025 å¹´ 12 æœˆ 2 æ—¥
**ç‰ˆæœ¬**: v1.0 (è®¾è®¡å®Œæˆ)
**çŠ¶æ€**: ğŸ“‹ å°±ç»ªå¾…å®ç°
